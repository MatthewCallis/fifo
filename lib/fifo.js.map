{"version":3,"file":"fifo.js","sources":["../src/localStorage.js","../src/fifo.js"],"sourcesContent":["export default class LocalStorageMock {\n  constructor() {\n    this.store = {};\n  }\n\n  clear() {\n    this.store = {};\n  }\n\n  getItem(key) {\n    return this.store[key] || null;\n  }\n\n  removeItem(key) {\n    delete this.store[key];\n  }\n\n  setItem(key, value) {\n    if (value) {\n      this.store[key] = value.toString();\n    }\n  }\n\n  key(index) {\n    return Object.keys(this.store)[index];\n  }\n\n  get length() {\n    return Object.keys(this.store).length;\n  }\n}\n","import LocalStorage from './localStorage.js';\n\n/**\n * The Fifo configuration object.\n *\n * @typedef {object} FifoOptions\n * @property {string} [namespace] The name of the key in localStorage.\n * @property {Function} [console] An optional console logging function.\n * @property {object} [shim] A shim class to act as localStorage in case it is missing.\n */\n\n/**\n * A single rule where a subject is compared against a given value on an SDK.\n *\n * @typedef {object} FifoData\n * @property {string[]} keys The collection of keys in the collection.\n * @property {object} items The actual items in the collection.\n */\n\nexport default class Fifo {\n  /**\n   * Contructs a new Fifo object.\n   *\n   * @param {FifoOptions} options The Fifo configuration.\n   */\n  constructor(options = {}) {\n    this.namespace = options.namespace || 'fifo';\n    this.noLS = false;\n    this.console = options.console || function console() {};\n    /** @type {FifoData} The localStoage data */\n    this.data = {\n      keys: [],\n      items: {},\n    };\n\n    this.checkLocalStorage(options.shim);\n\n    const dataFromStorage = JSON.parse(this.LS.getItem(this.namespace));\n    if (dataFromStorage && Object.prototype.hasOwnProperty.call(dataFromStorage, 'keys') && Object.prototype.hasOwnProperty.call(dataFromStorage, 'items')) {\n      this.data = dataFromStorage;\n    } else {\n      this.console('error', 'Namespace Collision, or, data is not in the correct format.');\n    }\n  }\n\n  /**\n   * Checks for the existence of localStorage and shims it should it not exist.\n   * This check has to be wrapped within a try/catch because of a SecurityError: DOM Exception 18 on iOS.\n   *\n   * @param {object} shim A shim class to act as localStorage in case it is missing.\n   */\n  checkLocalStorage(shim) {\n    /* c8 ignore start */\n    try {\n      if (typeof shim !== 'undefined' || (typeof localStorage !== 'undefined' && localStorage !== null)) {\n        this.LS = shim || localStorage;\n        this.noLS = false;\n      } else {\n        this.LS = new LocalStorage();\n        this.noLS = true;\n        this.console('warn', 'No localStorage, shimming.');\n      }\n    } catch (error) {\n      this.LS = new LocalStorage();\n      this.noLS = true;\n      this.console('warn', 'No localStorage, shimming.');\n    }\n    /* c8 ignore stop */\n  }\n\n  /**\n   * Attempts to save the key/value pair to localStorage.\n   * Possible Errors:\n   * - 18 for Safari: SecurityError: DOM Exception 18\n   * - 21 for some Safari\n   * - 22 for Chrome and Safari, 1014 for Firefox: QUOTA_EXCEEDED_ERR\n   * - -2147024882 for IE10 Out of Memory\n   *\n   * @returns {boolean} Whether or not the save was successful.\n   */\n  trySave() {\n    if (this.noLS) {\n      return false;\n    }\n\n    try {\n      this.LS.setItem(this.namespace, JSON.stringify(this.data));\n      return true;\n      /* c8 ignore next 7 */\n    } catch (error) {\n      if (error.code === 18 || error.code === 21 || error.code === 22 || error.code === 1014 || error.number === -2147024882) {\n        return false;\n      }\n      this.console('error', 'Error with localStorage:', error);\n      return true;\n    }\n  }\n\n  /**\n   * Attempts to remove the first item added to make room for the next.\n   *\n   * @returns {object} The item being removed.\n   */\n  removeFirstIn() {\n    const firstIn = this.data.keys.pop();\n    const removedItem = {\n      key: firstIn,\n      value: this.data.items[firstIn],\n    };\n    delete this.data.items[firstIn];\n    return removedItem;\n  }\n\n  /**\n   * Save the key/value pair to localStorage.\n   * This is difficult to test without a browser, and difficult in a browser.\n   *\n   * @returns {object[]} The item being removed.\n   */\n  save() {\n    const removed = [];\n    if (this.noLS) {\n      return removed;\n    }\n\n    /* c8 ignore next 7 */\n    while (!this.trySave()) {\n      if (this.data.keys.length) {\n        removed.push(this.removeFirstIn());\n      } else {\n        this.console('error', `All items removed from ${this.namespace}, still can't save.`);\n      }\n    }\n\n    return removed;\n  }\n\n  /**\n   * Set a key/value pair.\n   *\n   * @param {string} key The key to use in the key value pair.\n   * @param {string|number} value The value to use in the key value pair.\n   * @returns {Fifo} The current instance of Fifo.\n   */\n  set(key, value) {\n    this.data.items[key] = value;\n    const index = this.data.keys.indexOf(key);\n    if (index > -1) {\n      this.data.keys.splice(index, 1);\n    }\n    this.data.keys.unshift(key);\n    this.save();\n    return this;\n  }\n\n  /**\n   * Get a value for a given key.\n   *\n   * @param {string} [key] The key to use in the key value pair.\n   * @returns {*|[*]} The item, or, all items when no key is provided.\n   */\n  get(key) {\n    if (key) {\n      return this.data.items[key];\n    }\n\n    // Return all items.\n    return this.data.items;\n  }\n\n  /**\n   * All the keys currently being used.\n   *\n   * @returns {Array} The keys.\n   */\n  keys() {\n    return this.data.keys || [];\n  }\n\n  /**\n   * Checks for the existence of a key.\n   *\n   * @param {string} key - The key to check for.\n   * @returns {boolean} Wheter or not the key exist.\n   */\n  has(key) {\n    return this.data.keys.indexOf(key) !== -1;\n  }\n\n  /**\n   * Removes a key/value pair from the collection.\n   *\n   * @param {string} target - The key/value pair to find, can be one of a String, Regular Expression or a Function.\n   */\n  remove(target) {\n    if (target == null || !this.data.keys) {\n      return;\n    }\n\n    const { keys } = this.data;\n    keys.forEach((suspect, i) => {\n      if (suspect === target) {\n        this.data.keys.splice(i, 1);\n        delete this.data.items[suspect];\n      }\n    }, this);\n\n    this.save();\n  }\n\n  /**\n   * Resets the local data and saves empting out the localStorage to an empty state.\n   */\n  empty() {\n    this.data = {\n      keys: [],\n      items: {},\n    };\n    this.save();\n  }\n}\n"],"names":["LocalStorageMock","constructor","store","clear","getItem","key","removeItem","setItem","value","toString","index","Object","keys","length","Fifo","options","namespace","noLS","console","data","items","checkLocalStorage","shim","dataFromStorage","JSON","parse","LS","prototype","hasOwnProperty","call","localStorage","LocalStorage","error","trySave","stringify","code","number","removeFirstIn","firstIn","pop","removedItem","save","removed","push","set","indexOf","splice","unshift","get","has","remove","target","forEach","suspect","i","empty"],"mappings":"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"}